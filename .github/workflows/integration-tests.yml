name: Integration Tests

on:
  workflow_dispatch:

jobs:
  integration:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      RUN_INTEGRATION: "1"
      COMPOSE_PROJECT_NAME: llm-batch-ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Restore Docker model cache archive
        uses: actions/cache/restore@v4
        with:
          path: .cache/docker-cache.tgz
          key: docker-model-cache-${{ runner.os }}-${{ hashFiles('compose.yaml') }}

      - name: Restore Docker volume cache
        run: |
          mkdir -p .cache
          if [ -f .cache/docker-cache.tgz ]; then
            docker volume create "${COMPOSE_PROJECT_NAME}_cache"
            docker run --rm \
              -v "${COMPOSE_PROJECT_NAME}_cache:/volume" \
              -v "$PWD/.cache:/backup" \
              busybox sh -c "cd /volume && tar xzf /backup/docker-cache.tgz"
            echo "Restored docker cache volume from archive"
          else
            echo "No docker cache archive found"
          fi

      - name: Install dependencies
        run: uv sync --locked

      - name: Prepare .env for compose
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          if [ -z "$HF_TOKEN" ]; then
            echo "Repository secret HF_TOKEN is required"
            exit 1
          fi
          printf 'HF_TOKEN=%s\n' "$HF_TOKEN" > .env

      - name: Export runner UID/GID for compose
        run: |
          echo "UID=$(id -u)" >> "$GITHUB_ENV"
          echo "GID=$(id -g)" >> "$GITHUB_ENV"
          echo "Using UID=$(id -u) GID=$(id -g) for compose services"

      - name: Start compose services
        run: docker compose -f compose.yaml up -d llm batch

      - name: Wait for llm health
        run: |
          attempts=180
          for i in $(seq 1 "$attempts"); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || true)
            if [ "$code" = "200" ]; then
              echo "llm health endpoint is ready"
              exit 0
            fi
            sleep 2
          done
          echo "llm health endpoint did not become ready in time"
          exit 1

      - name: Run integration tests
        run: RUN_INTEGRATION=1 uv run pytest -o addopts='' tests/integration -m integration -vv -rA

      - name: Diagnose data permissions on failure
        if: failure()
        run: |
          echo "Runner identity:"
          id
          echo "data directory ownership and permissions:"
          ls -ldn data || true
          ls -lna data || true
          stat -c '%A %a %u:%g %n' data data/output.jsonl 2>/dev/null || true

      - name: Export Docker volume cache
        if: always()
        run: |
          mkdir -p .cache
          if docker volume inspect "${COMPOSE_PROJECT_NAME}_cache" >/dev/null 2>&1; then
            docker run --rm \
              -v "${COMPOSE_PROJECT_NAME}_cache:/volume" \
              -v "$PWD/.cache:/backup" \
              busybox sh -c "cd /volume && tar czf /backup/docker-cache.tgz ."
          else
            echo "Docker volume ${COMPOSE_PROJECT_NAME}_cache does not exist, skip export"
          fi

      - name: Save Docker model cache archive
        if: always() && hashFiles('.cache/docker-cache.tgz') != ''
        uses: actions/cache/save@v4
        with:
          path: .cache/docker-cache.tgz
          key: docker-model-cache-${{ runner.os }}-${{ hashFiles('compose.yaml') }}

      - name: Stop compose services
        if: always()
        run: docker compose -f compose.yaml down

      - name: Cleanup temporary .env
        if: always()
        run: rm -f .env
