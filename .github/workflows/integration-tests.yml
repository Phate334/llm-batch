name: Integration Tests

on:
  workflow_dispatch:

jobs:
  integration:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      RUN_INTEGRATION: "1"
      COMPOSE_PROJECT_NAME: llm-batch-ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --locked

      - name: Detect runner UID and GID for compose
        run: |
          echo "UID=$(id -u)" >> "$GITHUB_ENV"
          echo "GID=$(id -g)" >> "$GITHUB_ENV"
          echo "Runner UID:GID = $(id -u):$(id -g)"

      - name: Prepare .env for compose
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          if [ -z "$HF_TOKEN" ]; then
            echo "Repository secret HF_TOKEN is required"
            exit 1
          fi
          printf 'HF_TOKEN=%s\n' "$HF_TOKEN" > .env

      - name: Prepare writable data directory
        run: |
          mkdir -p data/requests
          rm -f data/input.jsonl data/output.jsonl
          chmod -R 0777 data
          ls -ldn data data/requests

      - name: Start compose services
        run: docker compose -f compose.yaml up -d llm batch

      - name: Wait for llm health
        run: |
          attempts=180
          for i in $(seq 1 "$attempts"); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || true)
            if [ "$code" = "200" ]; then
              echo "llm health endpoint is ready"
              exit 0
            fi
            sleep 2
          done
          echo "llm health endpoint did not become ready in time"
          exit 1

      - name: Run integration tests
        run: RUN_INTEGRATION=1 uv run pytest -o addopts='' tests/integration -m integration -vv -rA

      - name: Show batch container user and home
        if: always()
        run: docker compose -f compose.yaml run --rm -T batch sh -lc 'id; echo "HOME=${HOME:-<unset>}"; printf "XDG_CACHE_HOME=%s\n" "${XDG_CACHE_HOME:-<unset>}"'

      - name: Diagnose data permissions on failure
        if: failure()
        run: |
          echo "Runner identity:"
          id
          echo "Compose UID/GID env: UID=${UID:-<unset>} GID=${GID:-<unset>}"
          echo "data directory ownership and permissions:"
          ls -ldn data || true
          ls -lna data || true
          ls -ldn data/requests data/requests/sharegpt 2>/dev/null || true
          ls -lna data/requests data/requests/sharegpt 2>/dev/null || true
          stat -c '%A %a %u:%g %n' data data/requests data/requests/sharegpt data/output.jsonl data/requests/sharegpt/output.jsonl 2>/dev/null || true

      - name: Stop compose services
        if: always()
        run: docker compose -f compose.yaml down

      - name: Cleanup temporary .env
        if: always()
        run: rm -f .env
